<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç–µ–π</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #0f1b2d;
    color: #fff;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    background: #1a2e4a;
    padding: 16px 20px;
    border-bottom: 2px solid #1F4E79;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  header h1 {
    font-size: 18px;
    font-weight: 700;
    color: #4db8ff;
  }

  header p {
    font-size: 12px;
    color: #8899aa;
    margin-top: 2px;
  }

  .icon { font-size: 28px; }

  /* Settings block */
  #settings {
    background: #1a2e4a;
    margin: 16px;
    border-radius: 12px;
    padding: 16px;
    border: 1px solid #2a4a6a;
  }

  #settings h3 {
    font-size: 13px;
    color: #8899aa;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  #settings input {
    width: 100%;
    padding: 10px 12px;
    background: #0f1b2d;
    border: 1px solid #2a4a6a;
    border-radius: 8px;
    color: #fff;
    font-size: 13px;
    outline: none;
  }

  #settings input:focus { border-color: #4db8ff; }

  #settings small {
    display: block;
    color: #556677;
    font-size: 11px;
    margin-top: 6px;
  }

  /* Scanner */
  #scanner-wrap {
    margin: 0 16px;
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    background: #000;
    aspect-ratio: 1;
  }

  #reader { width: 100%; }

  .scan-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .scan-corner {
    position: absolute;
    width: 40px;
    height: 40px;
    border-color: #4db8ff;
    border-style: solid;
    border-width: 0;
  }
  .scan-corner.tl { top: 20px; left: 20px; border-top-width: 3px; border-left-width: 3px; }
  .scan-corner.tr { top: 20px; right: 20px; border-top-width: 3px; border-right-width: 3px; }
  .scan-corner.bl { bottom: 20px; left: 20px; border-bottom-width: 3px; border-left-width: 3px; }
  .scan-corner.br { bottom: 20px; right: 20px; border-bottom-width: 3px; border-right-width: 3px; }

  /* Status badge */
  #status {
    margin: 14px 16px 0;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    text-align: center;
    background: #1a2e4a;
    color: #8899aa;
    transition: all 0.3s;
  }

  #status.scanning { background: #1a3a5c; color: #4db8ff; }
  #status.loading  { background: #2a3a1a; color: #aad45a; }
  #status.success  { background: #1a3a2a; color: #4ddd88; }
  #status.error    { background: #3a1a1a; color: #ff6b6b; }
  #status.warning  { background: #3a2a0a; color: #ffb84d; }

  /* Result card */
  #result-card {
    margin: 14px 16px 0;
    background: #1a2e4a;
    border-radius: 12px;
    padding: 16px;
    border: 1px solid #2a4a6a;
    display: none;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  #result-card.success { border-color: #4ddd88; }
  #result-card.error   { border-color: #ff6b6b; }
  #result-card.warning { border-color: #ffb84d; }

  .result-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: #8899aa;
    margin-bottom: 4px;
  }

  .result-name {
    font-size: 22px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 4px;
  }

  .result-org {
    font-size: 14px;
    color: #4db8ff;
    margin-bottom: 12px;
  }

  .result-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .badge.green  { background: #1a3a2a; color: #4ddd88; }
  .badge.yellow { background: #3a2a0a; color: #ffb84d; }
  .badge.blue   { background: #1a2e4a; color: #4db8ff; border: 1px solid #2a4a6a; }
  .badge.red    { background: #3a1a1a; color: #ff6b6b; }

  /* Stats */
  #stats {
    margin: 14px 16px;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }

  .stat-box {
    background: #1a2e4a;
    border-radius: 10px;
    padding: 12px;
    text-align: center;
    border: 1px solid #2a4a6a;
  }

  .stat-num {
    font-size: 26px;
    font-weight: 700;
    color: #4db8ff;
  }

  .stat-lbl {
    font-size: 11px;
    color: #556677;
    margin-top: 2px;
  }

  /* Log */
  #log {
    margin: 0 16px 20px;
    background: #1a2e4a;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #2a4a6a;
  }

  #log h3 {
    padding: 12px 16px;
    font-size: 13px;
    color: #8899aa;
    border-bottom: 1px solid #2a4a6a;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  #log-list { max-height: 200px; overflow-y: auto; }

  .log-item {
    padding: 10px 16px;
    border-bottom: 1px solid #162030;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    animation: fadeIn 0.3s ease;
  }

  .log-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .log-dot.ok  { background: #4ddd88; }
  .log-dot.dup { background: #ffb84d; }
  .log-dot.err { background: #ff6b6b; }

  .log-name { flex: 1; color: #cce8ff; }
  .log-time { color: #556677; font-size: 11px; white-space: nowrap; }

  #log-empty {
    padding: 20px 16px;
    color: #556677;
    font-size: 13px;
    text-align: center;
  }
</style>
</head>
<body>

<header>
  <div class="icon">üé´</div>
  <div>
    <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç–µ–π</h1>
    <p>–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è ¬´–ë–∏–∑–Ω–µ—Å 2025¬ª</p>
  </div>
</header>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<div id="settings">
  <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ‚Äî Google Apps Script URL</h3>
  <input type="url" id="api-url"
    placeholder="https://script.google.com/macros/s/–í–ê–®–ê_–°–°–´–õ–ö–ê/exec"
    value="">
  <small>–í—Å—Ç–∞–≤—å—Ç–µ URL –≤–∞—à–µ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è Google Apps Script. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</small>
</div>

<!-- –°–∫–∞–Ω–µ—Ä -->
<div id="scanner-wrap">
  <div id="reader"></div>
  <div class="scan-overlay">
    <div class="scan-corner tl"></div>
    <div class="scan-corner tr"></div>
    <div class="scan-corner bl"></div>
    <div class="scan-corner br"></div>
  </div>
</div>

<div id="status" class="scanning">üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –≥–æ—Å—Ç—è</div>

<!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
<div id="result-card">
  <div class="result-label" id="card-label">–ì–æ—Å—Ç—å</div>
  <div class="result-name" id="card-name">‚Äî</div>
  <div class="result-org" id="card-org">‚Äî</div>
  <div class="result-meta" id="card-meta"></div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div id="stats">
  <div class="stat-box">
    <div class="stat-num" id="cnt-ok">0</div>
    <div class="stat-lbl">–û—Ç–º–µ—á–µ–Ω–æ</div>
  </div>
  <div class="stat-box">
    <div class="stat-num" id="cnt-dup" style="color:#ffb84d">0</div>
    <div class="stat-lbl">–ü–æ–≤—Ç–æ—Ä–Ω–æ</div>
  </div>
  <div class="stat-box">
    <div class="stat-num" id="cnt-err" style="color:#ff6b6b">0</div>
    <div class="stat-lbl">–û—à–∏–±–æ–∫</div>
  </div>
</div>

<!-- –õ–æ–≥ -->
<div id="log">
  <h3>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–º–µ—Ç–∫–∏</h3>
  <div id="log-list">
    <div id="log-empty">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
  </div>
</div>

<script>
  // ---- State ----
  let scanning = true;
  let lastScanned = '';
  let lastScannedTime = 0;
  let stats = { ok: 0, dup: 0, err: 0 };

  // ---- Persist API URL ----
  const apiInput = document.getElementById('api-url');
  const savedUrl = localStorage.getItem('guestApiUrl') || '';
  apiInput.value = savedUrl;
  apiInput.addEventListener('input', () => {
    localStorage.setItem('guestApiUrl', apiInput.value.trim());
  });

  // ---- QR Scanner ----
  const html5QrCode = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cameras => {
    if (!cameras.length) {
      setStatus('error', '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      return;
    }
    // Prefer back camera
    const cam = cameras.find(c => c.label.toLowerCase().includes('back')) || cameras[cameras.length - 1];

    html5QrCode.start(
      cam.id,
      { fps: 10, qrbox: { width: 220, height: 220 }, aspectRatio: 1 },
      onScanSuccess,
      () => {}
    );
  }).catch(() => setStatus('error', '‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ'));

  function onScanSuccess(decodedText) {
    const now = Date.now();
    // Debounce ‚Äî –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–¥–∏–Ω QR –¥–≤–∞–∂–¥—ã –∑–∞ 3 —Å–µ–∫—É–Ω–¥—ã
    if (decodedText === lastScanned && now - lastScannedTime < 3000) return;
    lastScanned = decodedText;
    lastScannedTime = now;

    processGuest(decodedText);
  }

  // ---- API call ----
  async function processGuest(id) {
    const url = apiInput.value.trim();
    if (!url) {
      setStatus('error', '‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ URL Google Apps Script –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
      return;
    }

    setStatus('loading', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º...');

    try {
      const res = await fetch(`${url}?id=${encodeURIComponent(id)}`);
      const data = await res.json();

      if (data.success) {
        stats.ok++;
        showCard('success', data);
        setStatus('success', '‚úÖ –ì–æ—Å—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!');
        addLog('ok', data.guest.name + ' ' + data.guest.surname, data.time);
        vibrate([100, 50, 100]);
      } else if (data.alreadyChecked) {
        stats.dup++;
        showCard('warning', data);
        setStatus('warning', '‚ö†Ô∏è –£–∂–µ –±—ã–ª –æ—Ç–º–µ—á–µ–Ω —Ä–∞–Ω–µ–µ');
        addLog('dup', data.guest.name + ' ' + data.guest.surname, nowTime());
        vibrate([300]);
      } else {
        stats.err++;
        showCard('error', data);
        setStatus('error', '‚ùå ' + (data.message || '–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω'));
        addLog('err', id, nowTime());
        vibrate([500]);
      }
    } catch (e) {
      stats.err++;
      setStatus('error', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
      addLog('err', id + ' (–Ω–µ—Ç —Å–≤—è–∑–∏)', nowTime());
    }

    updateStats();

    // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é
    setTimeout(() => {
      setStatus('scanning', 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –≥–æ—Å—Ç—è');
    }, 3000);
  }

  // ---- UI helpers ----
  function setStatus(cls, text) {
    const el = document.getElementById('status');
    el.className = cls;
    el.textContent = text;
  }

  function showCard(type, data) {
    const card = document.getElementById('result-card');
    card.style.display = 'block';
    card.className = type;

    const g = data.guest || {};
    const labels = { success: '‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', warning: '‚ö†Ô∏è –£–∂–µ –æ—Ç–º–µ—á–µ–Ω', error: '‚ùå –û—à–∏–±–∫–∞' };
    document.getElementById('card-label').textContent = labels[type] || '';
    document.getElementById('card-name').textContent =
      (g.name || '') + (g.surname ? ' ' + g.surname : '') || data.message || '‚Äî';
    document.getElementById('card-org').textContent =
      [g.org, g.position].filter(Boolean).join(' ¬∑ ') || '';

    const meta = document.getElementById('card-meta');
    meta.innerHTML = '';
    if (g.id) meta.innerHTML += `<span class="badge blue">${g.id}</span>`;
    if (type === 'success') meta.innerHTML += `<span class="badge green">‚úì –í—Ä–µ–º—è: ${data.time || nowTime()}</span>`;
    if (type === 'warning') meta.innerHTML += `<span class="badge yellow">–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</span>`;
    if (type === 'error')   meta.innerHTML += `<span class="badge red">–ù–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ</span>`;
  }

  function addLog(type, name, time) {
    const list = document.getElementById('log-list');
    const empty = document.getElementById('log-empty');
    if (empty) empty.remove();

    const item = document.createElement('div');
    item.className = 'log-item';
    item.innerHTML = `
      <div class="log-dot ${type}"></div>
      <div class="log-name">${name}</div>
      <div class="log-time">${time}</div>
    `;
    list.insertBefore(item, list.firstChild);

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ª–æ–≥ 50 –∑–∞–ø–∏—Å—è–º–∏
    while (list.children.length > 50) list.removeChild(list.lastChild);
  }

  function updateStats() {
    document.getElementById('cnt-ok').textContent = stats.ok;
    document.getElementById('cnt-dup').textContent = stats.dup;
    document.getElementById('cnt-err').textContent = stats.err;
  }

  function nowTime() {
    return new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function vibrate(pattern) {
    if (navigator.vibrate) navigator.vibrate(pattern);
  }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç–µ–π</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Manrope:wght@400;500;600;700;800&display=swap');

  :root {
    --bg:       #0a1628;
    --bg2:      #111f38;
    --bg3:      #162544;
    --border:   #1e3a5f;
    --accent:   #3b82f6;
    --accent2:  #60a5fa;
    --green:    #22c55e;
    --yellow:   #f59e0b;
    --red:      #ef4444;
    --text:     #e2e8f0;
    --muted:    #64748b;
    --mono:     'JetBrains Mono', monospace;
    --sans:     'Manrope', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .header-icon {
    width: 38px; height: 38px;
    background: linear-gradient(135deg, var(--accent), #1d4ed8);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
  }
  header h1 { font-size: 17px; font-weight: 800; letter-spacing: -0.3px; }

  .guard-chip {
    margin-left: auto; flex-shrink: 0;
    display: flex; align-items: center; gap: 6px;
    background: var(--bg3); border: 1px solid var(--border);
    border-radius: 20px; padding: 5px 10px 5px 8px;
    cursor: pointer; transition: border-color 0.2s;
    max-width: 160px;
  }
  .guard-chip:active { border-color: var(--accent); }
  .guard-chip-icon { font-size: 14px; flex-shrink: 0; }
  .guard-chip-text {
    font-size: 12px; font-weight: 700; color: var(--accent2);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  /* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
  .section {
    margin: 12px 14px 0;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
  }
  .section-title {
    font-size: 10px; font-weight: 700; letter-spacing: 1.2px;
    text-transform: uppercase; color: var(--muted);
    padding: 10px 14px 8px;
    border-bottom: 1px solid var(--border);
  }
  .section-body { padding: 12px 14px; }

  /* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
  .field-row { display: flex; flex-direction: column; gap: 5px; }
  .field-label { font-size: 11px; color: var(--muted); font-weight: 600; letter-spacing: 0.4px; }
  input[type="text"] {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    color: var(--text);
    font-family: var(--sans);
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type="text"]:focus { border-color: var(--accent); }
  input[type="text"]::placeholder { color: var(--muted); }

  /* ‚îÄ‚îÄ SCANNER ‚îÄ‚îÄ */
  .scanner-outer {
    margin: 12px 14px 0;
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    background: #000;
    aspect-ratio: 1;
  }
  #reader { width: 100%; }
  #reader video { border-radius: 0 !important; }

  /* ‚îÄ‚îÄ –¢–æ–Ω–∫–∏–µ —Å–∏–Ω–∏–µ —É–≥–ª–æ–≤—ã–µ –º–µ—Ç–∫–∏ ‚Äî –ø–æ —É–≥–ª–∞–º –í–°–ï–ì–û –æ–∫–Ω–∞ ‚îÄ‚îÄ */
  .corners-outer { position: absolute; inset: 0; pointer-events: none; }
  .corner-o {
    position: absolute; width: 22px; height: 22px;
    border-color: rgba(96,165,250,0.7); border-style: solid; border-width: 0;
    transition: border-color 0.3s;
  }
  .corner-o.tl { top: 14px; left: 14px; border-top-width: 1.5px; border-left-width: 1.5px; border-radius: 3px 0 0 0; }
  .corner-o.tr { top: 14px; right: 14px; border-top-width: 1.5px; border-right-width: 1.5px; border-radius: 0 3px 0 0; }
  .corner-o.bl { bottom: 14px; left: 14px; border-bottom-width: 1.5px; border-left-width: 1.5px; border-radius: 0 0 0 3px; }
  .corner-o.br { bottom: 14px; right: 14px; border-bottom-width: 1.5px; border-right-width: 1.5px; border-radius: 0 0 3px 0; }
  .corners-outer.success .corner-o { border-color: var(--green); }

  /* ‚îÄ‚îÄ –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∑–æ–Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚îÄ‚îÄ */
  .scan-frame {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 65%; aspect-ratio: 1;
    pointer-events: none;
  }

  /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –∑–æ–Ω—ã */
  .scan-frame::before {
    content: '';
    position: absolute; inset: 0;
    box-shadow: 0 0 0 2000px rgba(0,0,0,0.38);
    border-radius: 0;
  }

  /* –¢–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ –∑–æ–Ω—ã (–µ–¥–≤–∞ –∑–∞–º–µ—Ç–Ω–∞—è) */
  .scan-box {
    position: absolute; inset: 0;
    border: 1px solid rgba(96,165,250,0.2);
  }

  /* –¢–æ–ª—Å—Ç—ã–µ —É–≥–ª–æ–≤—ã–µ –º–µ—Ç–∫–∏ ‚Äî —Å—Ç—Ä–æ–≥–æ –ø–æ —É–≥–ª–∞–º scan-frame */
  .corners-inner { position: absolute; inset: 0; }
  .corner-i {
    position: absolute; width: 22px; height: 22px;
    border-color: rgba(220,228,240,0.9); border-style: solid; border-width: 0;
    transition: border-color 0.3s;
  }
  .corner-i.tl { top: 0; left: 0; border-top-width: 3px; border-left-width: 3px; }
  .corner-i.tr { top: 0; right: 0; border-top-width: 3px; border-right-width: 3px; }
  .corner-i.bl { bottom: 0; left: 0; border-bottom-width: 3px; border-left-width: 3px; }
  .corner-i.br { bottom: 0; right: 0; border-bottom-width: 3px; border-right-width: 3px; }
  .corners-inner.success .corner-i { border-color: var(--green); }

  /* –°–∫–∞–Ω–∏—Ä—É—é—â–∞—è –ª–∏–Ω–∏—è ‚Äî –≤–æ –≤—Å—é —à–∏—Ä–∏–Ω—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–∞–º–∫–∏ */
  .scan-line {
    position: absolute;
    left: 0; width: 100%;
    height: 2px;
    background: linear-gradient(to right, transparent, var(--accent2), transparent);
    border-radius: 2px;
    animation: scanMove 2s ease-in-out infinite;
  }
  @keyframes scanMove {
    0%   { top: 2%;  opacity: 0; }
    8%   { opacity: 1; }
    92%  { opacity: 1; }
    100% { top: 98%; opacity: 0; }
  }

  /* Scan hint */
  .scan-hint {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    padding: 10px 16px;
    background: linear-gradient(to top, rgba(0,0,0,0.75), transparent);
    font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.75);
    text-align: center; letter-spacing: 0.3px;
  }

  /* ‚îÄ‚îÄ MANUAL BUTTON ‚îÄ‚îÄ */
  .btn-manual {
    margin: 10px 14px 0;
    width: calc(100% - 28px);
    padding: 11px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--accent2);
    font-family: var(--sans);
    font-size: 13px; font-weight: 700;
    letter-spacing: 0.3px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: background 0.15s, border-color 0.15s;
  }
  .btn-manual:active { background: var(--bg2); }

  /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
  .stats {
    margin: 10px 14px 0;
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
  }
  .stat {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 6px;
    text-align: center;
  }
  .stat-num { font-size: 20px; font-weight: 800; font-family: var(--mono); }
  .stat-num.blue   { color: var(--accent2); }
  .stat-num.yellow { color: var(--yellow); }
  .stat-num.red    { color: var(--red); }
  .stat-lbl { font-size: 9px; color: var(--muted); font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; margin-top: 2px; }

  /* ‚îÄ‚îÄ LOG ‚îÄ‚îÄ */
  .log-wrap {
    margin: 10px 14px 16px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
  }
  .log-header {
    padding: 10px 14px;
    font-size: 10px; font-weight: 700; letter-spacing: 1.2px;
    text-transform: uppercase; color: var(--muted);
    border-bottom: 1px solid var(--border);
  }
  #log-list { max-height: 180px; overflow-y: auto; }
  .log-item {
    padding: 8px 14px;
    border-bottom: 1px solid rgba(30,58,95,0.5);
    display: flex; align-items: center; gap: 10px;
    animation: fadeSlide 0.25s ease;
  }
  @keyframes fadeSlide {
    from { opacity: 0; transform: translateY(-6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .log-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .log-dot.ok      { background: var(--green); }
  .log-dot.dup     { background: var(--yellow); }
  .log-dot.err     { background: var(--red); }
  .log-dot.uncheck { background: var(--red); opacity: 0.6; }
  .log-name { flex: 1; font-size: 12px; color: #93c5fd; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .log-time { font-size: 10px; color: var(--muted); font-family: var(--mono); white-space: nowrap; }
  .log-empty { padding: 16px; text-align: center; font-size: 12px; color: var(--muted); }

  /* ‚îÄ‚îÄ MODAL OVERLAY ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    align-items: center; justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.active { display: flex; }

  .modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 18px;
    width: 100%; max-width: 360px;
    overflow: hidden;
    animation: modalIn 0.2s ease;
  }
  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.93); }
    to   { opacity: 1; transform: scale(1); }
  }

  .modal-header {
    padding: 16px 18px 12px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .modal-icon {
    width: 34px; height: 34px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .modal-icon.new  { background: rgba(34,197,94,0.15); }
  .modal-icon.dup  { background: rgba(245,158,11,0.15); }
  .modal-icon.err  { background: rgba(239,68,68,0.15); }
  .modal-icon.input { background: rgba(59,130,246,0.15); }
  .modal-title { font-size: 13px; font-weight: 800; letter-spacing: -0.2px; }
  .modal-sub   { font-size: 10px; color: var(--muted); margin-top: 1px; }

  .modal-body { padding: 14px 18px; }

  .guest-appeal {
    font-size: 11px; font-weight: 600; letter-spacing: 0.3px;
    color: var(--muted);
    margin-bottom: 3px;
  }
  .guest-name {
    font-size: 20px; font-weight: 800; letter-spacing: -0.4px;
    line-height: 1.2; margin-bottom: 4px;
  }
  .guest-org  { font-size: 13px; color: var(--accent2); font-weight: 600; margin-bottom: 2px; }
  .guest-pos  { font-size: 12px; color: var(--muted); }

  .info-row {
    display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap;
  }
  .info-badge {
    padding: 4px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 700; font-family: var(--mono);
  }
  .info-badge.id     { background: var(--bg3); color: var(--accent2); border: 1px solid var(--border); }
  .info-badge.time   { background: rgba(34,197,94,0.12); color: var(--green); }
  .info-badge.warn   { background: rgba(245,158,11,0.12); color: var(--yellow); }
  .info-badge.guard  { background: rgba(59,130,246,0.12); color: var(--accent2); }

  .modal-footer {
    padding: 12px 18px 16px;
    display: flex; gap: 8px;
  }
  .btn {
    flex: 1; padding: 12px;
    border: none; border-radius: 10px;
    font-family: var(--sans); font-size: 14px; font-weight: 700;
    cursor: pointer; transition: opacity 0.15s;
  }
  .btn:active { opacity: 0.8; }
  .btn-confirm { background: var(--green); color: #fff; }
  .btn-cancel  { background: var(--bg3); color: var(--muted); border: 1px solid var(--border); }
  .btn-ok      { background: var(--accent); color: #fff; flex: 1; }
  .btn-close   { background: var(--bg3); color: var(--muted); border: 1px solid var(--border); }
  .btn-uncheck { background: var(--bg3); color: var(--red); border: 1px solid rgba(239,68,68,0.3); font-size: 12px; }

  /* Dossier grid for dup modal */
  .dossier {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 1px; margin-top: 12px;
    background: var(--border); border-radius: 8px; overflow: hidden;
  }
  .dossier-cell {
    background: var(--bg3); padding: 7px 10px;
  }
  .dossier-cell.full { grid-column: 1 / -1; }
  .dossier-label {
    font-size: 9px; font-weight: 700; letter-spacing: 0.8px;
    text-transform: uppercase; color: var(--muted); margin-bottom: 2px;
  }
  .dossier-value {
    font-size: 12px; font-weight: 700; color: var(--text);
    font-family: var(--mono);
  }
  .dossier-value.accent { color: var(--accent2); }
  .dossier-value.warn   { color: var(--yellow); }

  /* Search tabs */
  .search-tabs {
    display: flex; gap: 4px;
    background: var(--bg3); border-radius: 8px; padding: 3px;
  }
  .search-tab {
    flex: 1; padding: 7px;
    background: transparent; border: none; border-radius: 6px;
    font-family: var(--sans); font-size: 12px; font-weight: 700;
    color: var(--muted); cursor: pointer; transition: all 0.15s;
  }
  .search-tab.active {
    background: var(--bg2); color: var(--accent2);
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }

  /* Search result cards */
  .search-card {
    padding: 9px 12px; border-radius: 8px;
    background: var(--bg3); border: 1px solid var(--border);
    margin-bottom: 6px; cursor: pointer;
    display: flex; align-items: center; gap: 10px;
    transition: border-color 0.15s;
  }
  .search-card:active { border-color: var(--accent); }
  .search-card-info { flex: 1; min-width: 0; }
  .search-card-name { font-size: 13px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .search-card-sub  { font-size: 11px; color: var(--accent2); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .search-card-id   { font-size: 10px; font-family: var(--mono); color: var(--muted); margin-top: 2px; }
  .search-card-status { flex-shrink: 0; font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 10px; }
  .search-card-status.checked { background: rgba(245,158,11,0.15); color: var(--yellow); }
  .search-card-status.free    { background: rgba(34,197,94,0.12);  color: var(--green); }
  .search-hint { font-size: 11px; color: var(--muted); text-align: center; padding: 16px 0; }

  /* Manual input modal */
  .prefix-input {
    display: flex; align-items: center;
    background: var(--bg3); border: 1px solid var(--border);
    border-radius: 8px; overflow: hidden; margin-top: 10px;
  }
  .prefix-label {
    padding: 10px 12px;
    font-family: var(--mono); font-size: 14px; font-weight: 700;
    color: var(--accent2); background: var(--bg2);
    border-right: 1px solid var(--border);
    white-space: nowrap;
  }
  .prefix-input input {
    flex: 1; background: transparent; border: none;
    padding: 10px 12px; color: var(--text);
    font-family: var(--mono); font-size: 18px; font-weight: 700;
    outline: none; letter-spacing: 2px;
  }
  .prefix-input input::placeholder { color: var(--muted); font-size: 14px; letter-spacing: 0; }

  /* Status pill */
  #status-pill {
    margin: 8px 14px 0;
    padding: 9px 14px;
    border-radius: 10px;
    font-size: 12px; font-weight: 700;
    text-align: center;
    background: var(--bg3);
    color: var(--muted);
    border: 1px solid var(--border);
    transition: all 0.25s;
  }
  #status-pill.ok     { background: rgba(34,197,94,0.1);  color: var(--green);  border-color: rgba(34,197,94,0.3); }
  #status-pill.warn   { background: rgba(245,158,11,0.1); color: var(--yellow); border-color: rgba(245,158,11,0.3); }
  #status-pill.err    { background: rgba(239,68,68,0.1);  color: var(--red);    border-color: rgba(239,68,68,0.3); }
  #status-pill.load   { background: rgba(59,130,246,0.1); color: var(--accent2);border-color: rgba(59,130,246,0.3); }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-icon">üé´</div>
  <div>
    <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç–µ–π</h1>
  </div>
  <div class="guard-chip" onclick="openGuardModal(false)" id="guard-chip">
    <span class="guard-chip-icon">üëÆ</span>
    <span class="guard-chip-text" id="guard-chip-name">‚Äî</span>
  </div>
</header>

<!-- SCANNER -->
<div class="scanner-outer">
  <div id="reader"></div>
  <!-- –¢–æ–Ω–∫–∏–µ —Å–∏–Ω–∏–µ –º–µ—Ç–∫–∏ –ø–æ —É–≥–ª–∞–º –≤—Å–µ–≥–æ –æ–∫–Ω–∞ -->
  <div class="corners-outer" id="scan-corners-outer">
    <div class="corner-o tl"></div>
    <div class="corner-o tr"></div>
    <div class="corner-o bl"></div>
    <div class="corner-o br"></div>
  </div>
  <!-- –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞–º–∫–∞ —Å —Ç–æ–ª—Å—Ç—ã–º–∏ —É–≥–ª–æ–≤—ã–º–∏ –º–µ—Ç–∫–∞–º–∏ –∏ –ª–∏–Ω–∏–µ–π -->
  <div class="scan-frame">
    <div class="scan-box"></div>
    <div class="corners-inner" id="scan-corners-inner">
      <div class="corner-i tl"></div>
      <div class="corner-i tr"></div>
      <div class="corner-i bl"></div>
      <div class="corner-i br"></div>
    </div>
    <div class="scan-line"></div>
  </div>
  <div class="scan-hint">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –≥–æ—Å—Ç—è</div>
</div>

<!-- STATUS -->
<div id="status-pill">üì∑ –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...</div>

<!-- MANUAL BUTTON -->
<button class="btn-manual" onclick="openManual()">
  üîç –ù–∞–π—Ç–∏ –≥–æ—Å—Ç—è –≤—Ä—É—á–Ω—É—é
</button>

<!-- STATS -->
<div class="stats">
  <div class="stat">
    <div class="stat-num blue" id="cnt-ok">0</div>
    <div class="stat-lbl">–û—Ç–º–µ—á–µ–Ω–æ</div>
  </div>
  <div class="stat">
    <div class="stat-num yellow" id="cnt-dup">0</div>
    <div class="stat-lbl">–ü–æ–≤—Ç–æ—Ä–Ω–æ</div>
  </div>
  <div class="stat">
    <div class="stat-num red" id="cnt-err">0</div>
    <div class="stat-lbl">–û—à–∏–±–æ–∫</div>
  </div>
</div>

<!-- LOG -->
<div class="log-wrap">
  <div class="log-header">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–º–µ—Ç–∫–∏</div>
  <div id="log-list">
    <div class="log-empty">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
  </div>
</div>


<!-- ‚ïê‚ïê MODAL: –ù–û–í–´–ô –ì–û–°–¢–¨ ‚ïê‚ïê -->
<div class="modal-overlay" id="modal-new">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon new">‚úÖ</div>
      <div>
        <div class="modal-title">–ì–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω</div>
        <div class="modal-sub">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</div>
      </div>
    </div>
    <div class="modal-body">
      <div class="guest-appeal" id="mn-appeal"></div>
      <div class="guest-name" id="mn-name">‚Äî</div>
      <div class="guest-org"  id="mn-org">‚Äî</div>
      <div class="guest-pos"  id="mn-pos">‚Äî</div>
      <div class="info-row">
        <span class="info-badge id" id="mn-id">‚Äî</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeModal('modal-new')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-confirm" onclick="confirmGuest()">‚úì –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL: –£–ñ–ï –û–¢–ú–ï–ß–ï–ù ‚ïê‚ïê -->
<div class="modal-overlay" id="modal-dup">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon dup">‚ö†Ô∏è</div>
      <div>
        <div class="modal-title">–£–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</div>
        <div class="modal-sub">–ì–æ—Å—Ç—å –±—ã–ª –æ—Ç–º–µ—á–µ–Ω —Ä–∞–Ω–µ–µ</div>
      </div>
    </div>
    <div class="modal-body">
      <div class="guest-appeal" id="md-appeal"></div>
      <div class="guest-name"   id="md-name">‚Äî</div>
      <div class="guest-org"    id="md-org">‚Äî</div>
      <div class="guest-pos"    id="md-pos">‚Äî</div>
      <div class="dossier">
        <div class="dossier-cell">
          <div class="dossier-label">ID –≥–æ—Å—Ç—è</div>
          <div class="dossier-value accent" id="md-id">‚Äî</div>
        </div>
        <div class="dossier-cell">
          <div class="dossier-label">–ö–æ–º–µ–Ω–¥–∞–Ω—Ç</div>
          <div class="dossier-value" id="md-guard">‚Äî</div>
        </div>
        <div class="dossier-cell">
          <div class="dossier-label">–î–∞—Ç–∞ –æ—Ç–º–µ—Ç–∫–∏</div>
          <div class="dossier-value warn" id="md-date">‚Äî</div>
        </div>
        <div class="dossier-cell">
          <div class="dossier-label">–í—Ä–µ–º—è –æ—Ç–º–µ—Ç–∫–∏</div>
          <div class="dossier-value warn" id="md-time">‚Äî</div>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="flex-direction:column; gap:6px;">
      <button class="btn btn-ok"      onclick="closeModal('modal-dup')">–ü–æ–Ω—è—Ç–Ω–æ</button>
      <button class="btn btn-uncheck" onclick="confirmUncheck()">‚Ü© –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL: –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–¢–ú–ï–ù–´ ‚ïê‚ïê -->
<div class="modal-overlay" id="modal-uncheck">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon err" style="font-size:14px">‚Ü©</div>
      <div>
        <div class="modal-title">–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é?</div>
        <div class="modal-sub">–û—Ç–º–µ—Ç–∫–∞ –æ –ø—Ä–∏–±—ã—Ç–∏–∏ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞</div>
      </div>
    </div>
    <div class="modal-body">
      <div style="font-size:13px; color:var(--muted); line-height:1.6;">
        –î–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–∞—Ç–µ –ø—Ä–∏–±—ã—Ç–∏—è –≥–æ—Å—Ç—è
        <span id="mu-name" style="color:var(--text); font-weight:700;"></span>
        –±—É–¥—É—Ç —Å—Ç—ë—Ä—Ç—ã. –î–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –∂—É—Ä–Ω–∞–ª.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeModal('modal-uncheck')">–ù–∞–∑–∞–¥</button>
      <button class="btn" style="background:var(--red);color:#fff;" onclick="uncheckGuest()">–î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL: –ö–û–ú–ï–ù–î–ê–ù–¢ ‚ïê‚ïê -->
<div class="modal-overlay" id="modal-guard">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon input">üëÆ</div>
      <div>
        <div class="modal-title" id="mg-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
        <div class="modal-sub">–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞</div>
      </div>
    </div>
    <div class="modal-body">
      <div style="font-size:13px;color:var(--muted);line-height:1.5;margin-bottom:10px" id="mg-hint">
        –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û. –û–Ω–æ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∂—É—Ä–Ω–∞–ª–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
      </div>
      <input type="text" id="guard-name-input" placeholder="–ü–µ—Ç—Ä–æ–≤ –ü.–ü." style="font-size:15px;font-weight:600;">
    </div>
    <div class="modal-footer" id="mg-footer">
      <button class="btn btn-confirm" onclick="saveGuard()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL: –ù–ï –ù–ê–ô–î–ï–ù ‚ïê‚ïê -->
<div class="modal-overlay" id="modal-err">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon err">‚ùå</div>
      <div>
        <div class="modal-title" id="me-title">–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
        <div class="modal-sub" id="me-sub">ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</div>
      </div>
    </div>
    <div class="modal-body">
      <div style="font-size:13px; color:var(--muted); line-height:1.5;" id="me-text">
        –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å QR-–∫–æ–¥–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ok" onclick="closeModal('modal-err')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL: –†–£–ß–ù–û–ô –ü–û–ò–°–ö ‚ïê‚ïê -->
<div class="modal-overlay" id="modal-manual">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon input">‚å®Ô∏è</div>
      <div>
        <div class="modal-title">–ù–∞–π—Ç–∏ –≥–æ—Å—Ç—è</div>
        <div class="modal-sub">–ü–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ –ø–æ –§–ò–û</div>
      </div>
    </div>
    <div class="modal-body" style="padding-bottom:8px">

      <!-- –í–∫–ª–∞–¥–∫–∏ -->
      <div class="search-tabs">
        <button class="search-tab active" id="tab-id"  onclick="switchTab('id')">–ü–æ –Ω–æ–º–µ—Ä—É</button>
        <button class="search-tab"        id="tab-name" onclick="switchTab('name')">–ü–æ –§–ò–û</button>
      </div>

      <!-- –ü–∞–Ω–µ–ª—å: –ø–æ ID -->
      <div id="panel-id">
        <div class="prefix-input" style="margin-top:10px">
          <div class="prefix-label">GUEST-</div>
          <input type="text" id="manual-num" inputmode="numeric" pattern="[0-9]*" placeholder="0001" maxlength="6">
        </div>
      </div>

      <!-- –ü–∞–Ω–µ–ª—å: –ø–æ –§–ò–û -->
      <div id="panel-name" style="display:none">
        <input type="text" id="search-name" placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—Ç—å –§–ò–û..." style="margin-top:10px"
               oninput="onSearchInput()">
        <div id="search-results" style="margin-top:8px; max-height:220px; overflow-y:auto;"></div>
      </div>

    </div>
    <div class="modal-footer" id="manual-footer">
      <button class="btn btn-cancel" onclick="closeModal('modal-manual')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-ok" id="btn-submit-id" onclick="submitManual()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    </div>
  </div>
</div>


<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
// URL —Å–∫—Ä–∏–ø—Ç–∞ —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ config.json —á–µ—Ä–µ–∑ raw.githubusercontent.com
const GITHUB_USER = 'armrusemb-droid';
const GITHUB_REPO = 'scanner';
const CONFIG_URL  = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/config.json`;

let API_URL = '';
let pendingGuest = null;
let pendingUncheckId = null;
let lastScanned = '';
let lastTime = 0;
let stats = { ok: 0, dup: 0, err: 0 };
let scanning = true;
let clientIP  = '';
let clientUA  = '';

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º UA: –º–æ–¥–µ–ª—å –±–µ—Ä—ë–º –∏–∑ —Å—Ç—Ä–æ–∫–∏ UA (—Ç–∞–º —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ),
// –±—Ä–∞—É–∑–µ—Ä ‚Äî –∏–∑ userAgentData –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω (—Ç–æ—á–Ω–µ–µ –≤–µ—Ä—Å–∏—è), –∏–Ω–∞—á–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ UA.
async function detectUA() {
  const ua = navigator.userAgent;

  // ‚îÄ‚îÄ –ú–æ–¥–µ–ª—å –∏ OS –∏–∑ —Å—Ç—Ä–æ–∫–∏ UA (–≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ–º–æ) ‚îÄ‚îÄ
  let os = 'Unknown OS', model = '';
  const mAndroid = ua.match(/Android ([0-9.]+)/);
  if (mAndroid) {
    os = 'Android ' + mAndroid[1];
    // –î–æ Chrome 110 –º–æ–¥–µ–ª—å —è–≤–Ω–æ –≤ UA: "Android 11; Redmi Note 10S Build/..."
    // –ü–æ—Å–ª–µ Chrome 110 –º–æ–¥–µ–ª—å –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ "K" ‚Äî —Ç–æ–≥–¥–∞ model –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø—É—Å—Ç—ã–º
    const mModel = ua.match(/;\s*([^;)]+?)\s+Build\//);
    if (mModel && mModel[1].trim() !== 'K') model = mModel[1].trim();
  } else if (/iPhone OS ([0-9_]+)/.test(ua)) {
    os = 'iOS ' + ua.match(/iPhone OS ([0-9_]+)/)[1].replace(/_/g, '.'); model = 'iPhone';
  } else if (/iPad.*OS ([0-9_]+)/.test(ua)) {
    os = 'iPadOS ' + ua.match(/OS ([0-9_]+)/)[1].replace(/_/g, '.'); model = 'iPad';
  } else if (/Windows NT/.test(ua)) { os = 'Windows'; model = 'PC'; }
  else if (/Mac OS X/.test(ua))     { os = 'macOS';   model = 'Mac'; }
  else if (/Linux/.test(ua))        { os = 'Linux';   model = 'PC'; }

  // ‚îÄ‚îÄ –ë—Ä–∞—É–∑–µ—Ä: userAgentData —Ç–æ—á–Ω–µ–µ (–ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è), –∏–Ω–∞—á–µ –ø–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É ‚îÄ‚îÄ
  let br = '';
  if (navigator.userAgentData && navigator.userAgentData.getHighEntropyValues) {
    try {
      const d = await navigator.userAgentData.getHighEntropyValues(['brands']);
      const brand = (d.brands || [])
        .filter(b => !/not.a.brand/i.test(b.brand))
        .sort((a, b) => parseInt(b.version) - parseInt(a.version))[0];
      if (brand) br = brand.brand.replace('Google Chrome', 'Chrome').replace('Microsoft Edge', 'Edge') + ' ' + brand.version;
    } catch(e) { /* fallback */ }
  }
  if (!br) {
    if (/Chrome\/([0-9]+)/.test(ua) && !/Edg|OPR/.test(ua)) br = 'Chrome ' + ua.match(/Chrome\/([0-9]+)/)[1];
    else if (/Firefox\/([0-9]+)/.test(ua)) br = 'Firefox ' + ua.match(/Firefox\/([0-9]+)/)[1];
    else if (/Edg\/([0-9]+)/.test(ua))     br = 'Edge '    + ua.match(/Edg\/([0-9]+)/)[1];
    else if (/OPR\/([0-9]+)/.test(ua))     br = 'Opera '   + ua.match(/OPR\/([0-9]+)/)[1];
    else if (/Safari\//.test(ua))          br = 'Safari';
  }

  return (model ? model + ' ¬∑ ' : '') + os + (br ? ' / ' + br : '');
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç ip –∏ ua –∫ –ª—é–±–æ–º—É URL
function addMeta(url) {
  return url
    + '&ip=' + encodeURIComponent(clientIP)
    + '&ua=' + encodeURIComponent(clientUA);
}

// ‚îÄ‚îÄ LOAD CONFIG ‚îÄ‚îÄ
async function loadConfig() {
  try {
    const r = await fetch(CONFIG_URL + '?t=' + Date.now());
    const cfg = await r.json();
    API_URL = cfg.api_url || '';
  } catch(e) {
    API_URL = localStorage.getItem('guestApiUrl') || '';
  }
}

// ‚îÄ‚îÄ GUARD NAME ‚îÄ‚îÄ
let guardName = localStorage.getItem('guardName') || '';

function getGuard() { return guardName || '–ù–µ —É–∫–∞–∑–∞–Ω'; }

function updateGuardChip() {
  document.getElementById('guard-chip-name').textContent = guardName || '–ù–µ —É–∫–∞–∑–∞–Ω';
}

function openGuardModal(required) {
  // required=true ‚Äî –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫, –Ω–µ–ª—å–∑—è –∑–∞–∫—Ä—ã—Ç—å –±–µ–∑ –≤–≤–æ–¥–∞
  document.getElementById('mg-title').textContent = required ? '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!' : '–°–º–µ–Ω–∞ –∫–æ–º–µ–Ω–¥–∞–Ω—Ç–∞';
  document.getElementById('mg-hint').textContent  = required
    ? '–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û. –û–Ω–æ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∂—É—Ä–Ω–∞–ª–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.'
    : '–ò–∑–º–µ–Ω–∏—Ç–µ –§–ò–û –¥–µ–∂—É—Ä–Ω–æ–≥–æ –∫–æ–º–µ–Ω–¥–∞–Ω—Ç–∞.';
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã
  const footer = document.getElementById('mg-footer');
  footer.innerHTML = required
    ? '<button class="btn btn-confirm" onclick="saveGuard()">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>'
    : '<button class="btn btn-cancel" onclick="closeModal(\'modal-guard\')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-confirm" onclick="saveGuard()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>';
  document.getElementById('guard-name-input').value = guardName;
  // required-–º–æ–¥–∞–ª –Ω–µ–ª—å–∑—è –∑–∞–∫—Ä—ã—Ç—å –∫–ª–∏–∫–æ–º –ø–æ –æ–≤–µ—Ä–ª–µ—é
  const overlay = document.getElementById('modal-guard');
  overlay.onclick = required ? null : (e => { if (e.target === overlay) closeModal('modal-guard'); });
  openModal('modal-guard');
  setTimeout(() => document.getElementById('guard-name-input').focus(), 150);
}

function saveGuard() {
  const val = document.getElementById('guard-name-input').value.trim();
  if (!val) {
    document.getElementById('guard-name-input').style.borderColor = 'var(--red)';
    setTimeout(() => document.getElementById('guard-name-input').style.borderColor = '', 1000);
    return;
  }
  guardName = val;
  localStorage.setItem('guardName', guardName);
  updateGuardChip();
  closeModal('modal-guard');
}

// Enter –≤ –ø–æ–ª–µ –∫–æ–º–µ–Ω–¥–∞–Ω—Ç–∞
document.getElementById('guard-name-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') saveGuard();
});

// ‚îÄ‚îÄ SCANNER ‚îÄ‚îÄ
const html5QrCode = new Html5Qrcode("reader");

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –∫–æ–º–µ–Ω–¥–∞–Ω—Ç–∞ –≤ —à–∞–ø–∫–µ —Å—Ä–∞–∑—É
updateGuardChip();

loadConfig().then(async () => {
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (async ‚Äî –¥–ª—è userAgentData API)
  clientUA = await detectUA();

  // –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π IP –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  try {
    const r = await fetch('https://api.ipify.org?format=json');
    const d = await r.json();
    clientIP = d.ip || '';
  } catch(e) { clientIP = 'unknown'; }

  // –ï—Å–ª–∏ –∏–º—è –Ω–µ –∑–∞–¥–∞–Ω–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –º–æ–¥–∞–ª
  if (!guardName) {
    openGuardModal(true);
  }

  Html5Qrcode.getCameras().then(cams => {
    if (!cams.length) { setStatus('err', '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }
    const cam = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[cams.length - 1];
    html5QrCode.start(
      cam.id,
      { fps: 10, qrbox: { width: 200, height: 200 }, aspectRatio: 1 },
      onScan, () => {}
    );
  }).catch(() => setStatus('err', '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ'));
});

function onScan(text) {
  const now = Date.now();
  if (text === lastScanned && now - lastTime < 3500) return;
  lastScanned = text; lastTime = now;
  vibrate([60]);
  const co = document.getElementById('scan-corners-outer');
  const ci = document.getElementById('scan-corners-inner');
  if (co) { co.classList.add('success'); setTimeout(() => co.classList.remove('success'), 800); }
  if (ci) { ci.classList.add('success'); setTimeout(() => ci.classList.remove('success'), 800); }
  processID(text.trim());
}

// ‚îÄ‚îÄ PROCESS ‚îÄ‚îÄ
async function processID(id) {
  if (!id) return;
  if (!API_URL) {
    showErr('–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω API URL', '–î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª config.json —Å –∞–¥—Ä–µ—Å–æ–º —Å–∫—Ä–∏–ø—Ç–∞.');
    return;
  }
  setStatus('load', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º...');

  try {
    const url = addMeta(`${API_URL}?id=${encodeURIComponent(id)}&guard=${encodeURIComponent(getGuard())}`);
    const r = await fetch(url);
    const d = await r.json();

    if (d.success) {
      // –ù–æ–≤—ã–π –≥–æ—Å—Ç—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      pendingGuest = { id, data: d };
      showModalNew(d.guest);
      setStatus('ok', '‚úÖ –ì–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ');
    } else if (d.alreadyChecked) {
      stats.dup++;
      showModalDup(d.guest);
      setStatus('warn', '‚ö†Ô∏è –ì–æ—Å—Ç—å —É–∂–µ –±—ã–ª –æ—Ç–º–µ—á–µ–Ω');
      addLog('dup', d.guest, nowTime());
      vibrate([300]);
    } else {
      stats.err++;
      showErr(d.message || '–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω', `ID: ${id}`);
      setStatus('err', '‚ùå ' + (d.message || '–ù–µ –Ω–∞–π–¥–µ–Ω'));
      addLog('err', { name: id, org: '', id: '' }, nowTime());
      vibrate([500]);
    }
  } catch(e) {
    stats.err++;
    setStatus('err', '‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    addLog('err', { name: id + ' (–Ω–µ—Ç —Å–≤—è–∑–∏)', org: '', id: '' }, nowTime());
  }
  updateStats();
}

// ‚îÄ‚îÄ CONFIRM ‚îÄ‚îÄ
async function confirmGuest() {
  if (!pendingGuest) return;
  const guestId = pendingGuest.id;
  const guardName = getGuard();
  pendingGuest = null;
  closeModal('modal-new');
  setStatus('load', '‚è≥ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º...');
  if (!API_URL) { setStatus('err', '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω API URL'); return; }

  try {
    const url = addMeta(API_URL + '?id=' + encodeURIComponent(guestId) + '&guard=' + encodeURIComponent(guardName) + '&confirm=1');
    const r = await fetch(url);
    const d = await r.json();

    if (d.success) {
      stats.ok++;
      setStatus('ok', '‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ' + (d.guest ? d.guest.name : ''));
      addLog('ok', d.guest || { name: guestId }, nowTime());
      vibrate([80, 40, 80]);
    } else {
      stats.err++;
      setStatus('err', '‚ùå –û—à–∏–±–∫–∞: ' + d.message);
    }
  } catch(e) {
    stats.err++;
    setStatus('err', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
    console.error('confirmGuest error:', e);
  }

  updateStats();
  setTimeout(() => setStatus('', 'üì∑ –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...'), 2500);
}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
function showModalNew(g) {
  document.getElementById('mn-appeal').textContent = g.appeal || '';
  document.getElementById('mn-name').textContent   = g.name || '‚Äî';
  document.getElementById('mn-org').textContent    = g.org  || '‚Äî';
  document.getElementById('mn-pos').textContent    = g.position || '‚Äî';
  document.getElementById('mn-id').textContent     = g.id   || '‚Äî';
  openModal('modal-new');
}

function formatCheckedDate(raw) {
  if (!raw) return '‚Äî';
  const s = raw.toString().trim();
  if (/^\d{2}\.\d{2}\.\d{4}$/.test(s)) return s;
  if (s.includes('T')) {
    const d = new Date(s);
    if (!isNaN(d)) return d.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric' });
  }
  return s || '‚Äî';
}

function formatCheckedTime(raw) {
  if (!raw) return '';
  const s = raw.toString().trim();
  if (/^\d{2}:\d{2}(:\d{2})?$/.test(s)) return s.slice(0, 5);
  if (s.includes('T')) {
    const d = new Date(s);
    if (!isNaN(d)) {
      const hh = String(d.getUTCHours()).padStart(2, '0');
      const mm = String(d.getUTCMinutes()).padStart(2, '0');
      return `${hh}:${mm}`;
    }
  }
  return s;
}

function showModalDup(g) {
  pendingUncheckId = g.id || null;
  document.getElementById('md-appeal').textContent = g.appeal || '';
  document.getElementById('md-name').textContent   = g.name || '‚Äî';
  document.getElementById('md-org').textContent    = g.org  || '‚Äî';
  document.getElementById('md-pos').textContent    = g.position || '‚Äî';
  document.getElementById('md-id').textContent     = g.id   || '‚Äî';
  const dateStr = formatCheckedDate(g.checkedDate);
  const timeStr = formatCheckedTime(g.checkedTime);
  document.getElementById('md-date').textContent   = dateStr;
  document.getElementById('md-time').textContent   = timeStr || '‚Äî';
  document.getElementById('md-guard').textContent  = g.guard || '–ù–µ —É–∫–∞–∑–∞–Ω';
  openModal('modal-dup');
}

function showErr(title, sub) {
  document.getElementById('me-title').textContent = title;
  document.getElementById('me-text').textContent  = sub || '';
  openModal('modal-err');
}

function openModal(id) {
  document.getElementById(id).classList.add('active');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('active');
  if (id === 'modal-new' && pendingGuest) { pendingGuest = null; setStatus('', 'üì∑ –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...'); }
  if (id === 'modal-uncheck') pendingUncheckId = null;
}

// ‚îÄ‚îÄ UNCHECK ‚îÄ‚îÄ
function confirmUncheck() {
  const name = document.getElementById('md-name').textContent;
  document.getElementById('mu-name').textContent = name;
  closeModal('modal-dup');
  openModal('modal-uncheck');
}

async function uncheckGuest() {
  if (!pendingUncheckId) return;
  const guestId = pendingUncheckId;
  pendingUncheckId = null;
  closeModal('modal-uncheck');
  setStatus('load', '‚è≥ –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é...');
  try {
    const url = addMeta(API_URL + '?id=' + encodeURIComponent(guestId) + '&guard=' + encodeURIComponent(getGuard()) + '&uncheck=1');
    const r = await fetch(url);
    const d = await r.json();
    if (d.success) {
      stats.dup = Math.max(0, stats.dup - 1);
      setStatus('warn', '‚Ü© –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞');
      addLog('uncheck', d.guest || { name: guestId }, nowTime());
      vibrate([100, 50, 100]);
    } else {
      setStatus('err', '‚ùå –û—à–∏–±–∫–∞: ' + d.message);
    }
  } catch(e) {
    setStatus('err', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
  }
  updateStats();
  setTimeout(() => setStatus('', 'üì∑ –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...'), 2500);
}

// ‚îÄ‚îÄ MANUAL / SEARCH ‚îÄ‚îÄ
let currentTab = 'id';
let searchTimer = null;

function openManual() {
  currentTab = 'id';
  document.getElementById('manual-num').value = '';
  document.getElementById('search-name').value = '';
  document.getElementById('search-results').innerHTML = '<div class="search-hint">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –§–ò–û</div>';
  switchTab('id');
  openModal('modal-manual');
  setTimeout(() => document.getElementById('manual-num').focus(), 150);
}

function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tab-id').classList.toggle('active', tab === 'id');
  document.getElementById('tab-name').classList.toggle('active', tab === 'name');
  document.getElementById('panel-id').style.display   = tab === 'id'   ? '' : 'none';
  document.getElementById('panel-name').style.display = tab === 'name' ? '' : 'none';
  document.getElementById('btn-submit-id').style.display = tab === 'id' ? '' : 'none';
  if (tab === 'name') setTimeout(() => document.getElementById('search-name').focus(), 100);
  if (tab === 'id')   setTimeout(() => document.getElementById('manual-num').focus(), 100);
}

function submitManual() {
  const num = document.getElementById('manual-num').value.trim();
  if (!num) return;
  const padded = num.padStart(4, '0');
  const id = 'GUEST-' + padded;
  closeModal('modal-manual');
  processID(id);
}

function onSearchInput() {
  clearTimeout(searchTimer);
  const q = document.getElementById('search-name').value.trim();
  if (q.length < 2) {
    document.getElementById('search-results').innerHTML = '<div class="search-hint">–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞</div>';
    return;
  }
  document.getElementById('search-results').innerHTML = '<div class="search-hint">‚è≥ –ü–æ–∏—Å–∫...</div>';
  searchTimer = setTimeout(() => doSearch(q), 400);
}

async function doSearch(q) {
  if (!API_URL) {
    document.getElementById('search-results').innerHTML = '<div class="search-hint">‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω API URL</div>';
    return;
  }
  try {
    const url = addMeta(API_URL + '?search=' + encodeURIComponent(q));
    const r = await fetch(url);
    const d = await r.json();
    if (!d.results || d.results.length === 0) {
      // –õ–æ–≥–∏—Ä—É–µ–º –Ω–µ—É–¥–∞—á–Ω—ã–π –ø–æ–∏—Å–∫
      addLog('err', { name: '¬´' + q + '¬ª', org: '–ü–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', id: '' }, nowTime());
      stats.err++;
      updateStats();
    }
    renderSearchResults(d.results || []);
  } catch(e) {
    document.getElementById('search-results').innerHTML = '<div class="search-hint">‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
  }
}

function renderSearchResults(results) {
  const box = document.getElementById('search-results');
  if (!results.length) {
    box.innerHTML = '<div class="search-hint">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
    return;
  }
  box.innerHTML = results.map(g => {
    const checked = g.checkedDate && g.checkedDate.toString().trim() !== '';
    const statusClass = checked ? 'checked' : 'free';
    const statusText  = checked ? '‚úì –û—Ç–º–µ—á–µ–Ω' : '‚óã –ù–µ –æ—Ç–º–µ—á–µ–Ω';
    return `
      <div class="search-card" onclick="selectSearchResult('${g.id}')">
        <div class="search-card-info">
          <div class="search-card-name">${g.name}</div>
          <div class="search-card-sub">${g.org || ''}</div>
          <div class="search-card-id">${g.id}${g.position ? ' ¬∑ ' + g.position : ''}</div>
        </div>
        <div class="search-card-status ${statusClass}">${statusText}</div>
      </div>`;
  }).join('');
}

function selectSearchResult(id) {
  closeModal('modal-manual');
  processID(id);
}

// ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ
function setStatus(type, text) {
  const el = document.getElementById('status-pill');
  el.className = type ? `${type}` : '';
  el.textContent = text;
}

// ‚îÄ‚îÄ LOG ‚îÄ‚îÄ
const LOG_LABELS = { ok: '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', dup: '–£–∂–µ –æ—Ç–º–µ—á–µ–Ω', err: '–û—à–∏–±–∫–∞', uncheck: '–û—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' };
const LOG_COLORS = { ok: 'var(--green)', dup: 'var(--yellow)', err: 'var(--red)', uncheck: 'var(--red)' };

function addLog(type, guest, time) {
  const list  = document.getElementById('log-list');
  const empty = list.querySelector('.log-empty');
  if (empty) empty.remove();

  const name   = (typeof guest === 'object') ? (guest.name || '‚Äî')     : guest;
  const org    = (typeof guest === 'object') ? (guest.org  || '')       : '';
  const id     = (typeof guest === 'object') ? (guest.id   || '')       : '';
  const label  = LOG_LABELS[type] || '';
  const color  = LOG_COLORS[type] || 'var(--muted)';

  const item = document.createElement('div');
  item.className = 'log-item';
  item.style.flexDirection = 'column';
  item.style.alignItems    = 'flex-start';
  item.style.gap           = '2px';
  item.style.padding       = '9px 14px';
  item.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;width:100%">
      <div class="log-dot ${type}"></div>
      <div class="log-name" style="flex:1">${name}</div>
      <div class="log-time">${time}</div>
    </div>
    ${org ? `<div style="font-size:11px;color:var(--accent2);padding-left:15px;font-weight:600">${org}</div>` : ''}
    <div style="display:flex;align-items:center;gap:6px;padding-left:15px">
      ${id ? `<span style="font-size:10px;font-family:var(--mono);color:var(--muted)">${id}</span>` : ''}
      <span style="font-size:10px;font-weight:700;color:${color}">${label}</span>
    </div>
  `;
  list.insertBefore(item, list.firstChild);
  while (list.children.length > 50) list.removeChild(list.lastChild);
}

function updateStats() {
  document.getElementById('cnt-ok').textContent  = stats.ok;
  document.getElementById('cnt-dup').textContent = stats.dup;
  document.getElementById('cnt-err').textContent = stats.err;
}

function nowTime() {
  return new Date().toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
}
function vibrate(p) { if (navigator.vibrate) navigator.vibrate(p); }

// Enter –≤ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ
document.getElementById('manual-num').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitManual();
});
document.getElementById('search-name').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    clearTimeout(searchTimer);
    const q = document.getElementById('search-name').value.trim();
    if (q.length >= 2) doSearch(q);
  }
});
</script>
</body>
</html>
